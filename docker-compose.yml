services:
  mongodb:
    image: mongo:7.0
    container_name: pdfa-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-change_this_admin_password}
      MONGO_INITDB_DATABASE: pdfa_service
      PDFA_DB_USER: pdfa_user
      PDFA_DB_PASSWORD: ${PDFA_DB_PASSWORD:-change_this_password}
    volumes:
      - mongodb_data:/data/db
      - ./docker/mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    networks:
      - pdfa-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  pdfa:
    image: kutsenko/pdfa-service
    build: .
    container_name: pdfa-service
    ports:
      - "8000:8000"
    environment:
      - PYTHONUNBUFFERED=1
      # PDF Compression Settings (balanced defaults for quality and file size)
      - PDFA_IMAGE_DPI=150          # Image resolution in DPI (72-600, default: 150)
      - PDFA_JPG_QUALITY=85         # JPEG compression quality (1-100, default: 85)
      - PDFA_OPTIMIZE=1             # Optimization level (0-3, default: 1)
      - PDFA_REMOVE_VECTORS=true    # Remove vector graphics (true/false, default: true)
      - PDFA_JBIG2_LOSSY=false      # Use lossy JBIG2 compression (true/false, default: false)
      - PDFA_JBIG2_PAGE_GROUP_SIZE=10  # JBIG2 page grouping (0-100+, default: 10)
      # Authentication Settings
      - PDFA_ENABLE_AUTH=${PDFA_ENABLE_AUTH-false}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID-none}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET-none}
      - JWT_SECRET_KEY="${JWT_SECRET_KEY-none}
      - JWT_EXPIRY_HOURS=${JWT_EXPIRY_HOURS-24}
      - OAUTH_REDIRECT_URI=${OAUTH_REDIRECT_URI-http://localhost:8000/auth/callback}
      # MongoDB Settings (Required)
      - MONGODB_URI=mongodb://pdfa_user:${PDFA_DB_PASSWORD:-change_this_password}@mongodb:27017/pdfa_service?authSource=admin
      - MONGODB_DATABASE=pdfa_service
      - MONGODB_JOB_TTL_DAYS=90
      # Accessibility Camera Settings (Optional)
      - A11Y_CAMERA_DEBUG=${A11Y_CAMERA_DEBUG:-false}
      - A11Y_CAMERA_HYSTERESIS_UPPER=${A11Y_CAMERA_HYSTERESIS_UPPER:-0.45}
      - A11Y_CAMERA_HYSTERESIS_LOWER=${A11Y_CAMERA_HYSTERESIS_LOWER:-0.35}
      - A11Y_CAMERA_CONFIDENCE_MIN_AREA=${A11Y_CAMERA_CONFIDENCE_MIN_AREA:-0.10}
      - A11Y_CAMERA_CONFIDENCE_MAX_AREA=${A11Y_CAMERA_CONFIDENCE_MAX_AREA:-0.90}
      - A11Y_CAMERA_CONFIDENCE_PEAK_AREA=${A11Y_CAMERA_CONFIDENCE_PEAK_AREA:-0.40}
      - A11Y_CAMERA_STABLE_FRAMES=${A11Y_CAMERA_STABLE_FRAMES:-10}
      - A11Y_CAMERA_COUNTDOWN_SECONDS=${A11Y_CAMERA_COUNTDOWN_SECONDS:-2}
      - A11Y_CAMERA_ANALYSIS_FPS=${A11Y_CAMERA_ANALYSIS_FPS:-10}
      - A11Y_CAMERA_JPEG_QUALITY_NORMAL=${A11Y_CAMERA_JPEG_QUALITY_NORMAL:-0.85}
      - A11Y_CAMERA_JPEG_QUALITY_AUTOCROP=${A11Y_CAMERA_JPEG_QUALITY_AUTOCROP:-0.90}
      - A11Y_CAMERA_TONE_SUCCESS_FREQ=${A11Y_CAMERA_TONE_SUCCESS_FREQ:-880}
      - A11Y_CAMERA_TONE_SUCCESS_DURATION=${A11Y_CAMERA_TONE_SUCCESS_DURATION:-200}
      - A11Y_CAMERA_TONE_WARNING_FREQ=${A11Y_CAMERA_TONE_WARNING_FREQ:-440}
      - A11Y_CAMERA_TONE_WARNING_DURATION=${A11Y_CAMERA_TONE_WARNING_DURATION:-150}
      - A11Y_CAMERA_TONE_COUNTDOWN_FREQ=${A11Y_CAMERA_TONE_COUNTDOWN_FREQ:-523}
      - A11Y_CAMERA_TONE_COUNTDOWN_DURATION=${A11Y_CAMERA_TONE_COUNTDOWN_DURATION:-100}
      - A11Y_CAMERA_ANNOUNCEMENT_THROTTLE=${A11Y_CAMERA_ANNOUNCEMENT_THROTTLE:-2000}
      - A11Y_CAMERA_EDGE_MARGIN=${A11Y_CAMERA_EDGE_MARGIN:-20}
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - pdfa-network
    restart: unless-stopped

networks:
  pdfa-network:
    driver: bridge

volumes:
  mongodb_data:
    driver: local
